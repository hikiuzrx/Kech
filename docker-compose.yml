version: '3.8'

services:
  # ==========================================
  # Infrastructure
  # ==========================================

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: smartwaste-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      # We use the main DB name here, others created by script
      POSTGRES_DB: smartwaste
      POSTGRES_MULTIPLE_DATABASES: smartwaste,smartwaste_shipments
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh
      # Mount migrations for main backend
      - ./go_backend/internal/database/migrations:/docker-entrypoint-initdb.d/1_main_migrations:ro
      # Mount migrations for shipment tracker
      - ./shipment_tracker/internal/database/migrations:/docker-entrypoint-initdb.d/2_shipment_migrations:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d smartwaste" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - smartwaste-network
    restart: unless-stopped

  # NATS JetStream
  nats:
    image: nats:2.10-alpine
    container_name: smartwaste-nats
    ports:
      - "4222:4222" # Client connections
      - "8222:8222" # HTTP management
    command: [ "--jetstream", "--store_dir=/data" ]
    volumes:
      - nats_data:/data
    networks:
      - smartwaste-network
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # MQTT Broker (Mosquitto)
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: smartwaste-mqtt
    volumes:
      - ./go_backend/mosquitto/config:/mosquitto/config:ro
      - mosquitto_data:/mosquitto/data
      - mosquitto_logs:/mosquitto/log
    ports:
      - "1883:1883"
      - "9001:9001"
    healthcheck:
      test: [ "CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3" ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - smartwaste-network
    restart: unless-stopped

  # ==========================================
  # Microservices
  # ==========================================

  # Main Backend Service (Go)
  go-backend:
    build:
      context: ./go_backend
      dockerfile: Dockerfile
    container_name: smartwaste-backend
    environment:
      SERVER_PORT: "8080"
      SERVER_MODE: "debug"
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: smartwaste
      DB_SSLMODE: disable
      MQTT_BROKER: mosquitto
      MQTT_PORT: "1883"
      MQTT_CLIENT_ID: smartwaste-backend
      NATS_URL: "nats://nats:4222"
      GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY:-}
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - smartwaste-network
    restart: unless-stopped

  # Shipment Tracker Service (Go Microusevice)
  shipment-tracker:
    build:
      context: ./shipment_tracker
      dockerfile: Dockerfile
    container_name: smartwaste-shipment-tracker
    environment:
      SERVER_PORT: "8082"
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: smartwaste_shipments
      NATS_URL: "nats://nats:4222"
      BLOCKCHAIN_RPC_URL: ${BLOCKCHAIN_RPC_URL}
      BLOCKCHAIN_PRIVATE_KEY: ${BLOCKCHAIN_PRIVATE_KEY}
    ports:
      - "8082:8082"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - smartwaste-network
    restart: unless-stopped

  # ==========================================
  # Devices / IoT
  # ==========================================

  # IoT Sensor Simulator
  iot-sensor:
    build:
      context: ./iot_sensor
      dockerfile: Dockerfile
    container_name: smartwaste-iot-sensor
    environment:
      MQTT_BROKER: "tcp://mosquitto:1883"
      BIN_ID: "sim-bin-001"
      BIN_HEIGHT_CM: "100"
      READ_INTERVAL_SECONDS: "5"
      SIMULATION_MODE: "true"
    depends_on:
      mosquitto:
        condition: service_healthy
    networks:
      - smartwaste-network
    restart: unless-stopped

  # ==========================================
  # Tools
  # ==========================================

  # Adminer
  adminer:
    image: adminer:4
    container_name: smartwaste-adminer
    ports:
      - "8081:8080"
    depends_on:
      - postgres
    networks:
      - smartwaste-network
    profiles:
      - tools

networks:
  smartwaste-network:
    driver: bridge

volumes:
  postgres_data:
  mosquitto_data:
  mosquitto_logs:
  nats_data:
